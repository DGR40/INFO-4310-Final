<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Project 3</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      .outline {
        border: 1px solid black;
      }
      .gridlines line {
        stroke: #bbb;
      }
      .gridlines .domain {
        stroke: none;
      }
      .button {
        height: 30px;
        width: 200px;
      }
      button {
        font-size: 16px;
        padding: 8px;
        width: 200px;
        border: none;
        background-color: #ddd;
        cursor: pointer;
      }
      button:hover {
        background-color: #ccc;
      }

      .arrow:hover {
        opacity: 0.4;
      }
      .arrow {
        display: inline-block;
        width: 16px;
        height: 16px;
        background-image: url("https://cdn-icons-png.flaticon.com/512/271/271228.png");
        background-size: contain;
        background-repeat: no-repeat;
        cursor: pointer;
      }
      .arrow-left {
        transform: rotate(180deg);
      }

      /* .yButtonContainer {
        display: flex;
        flex-direction: row;
      } */

      .scatter-container {
        display: flex;
      }
    </style>
  </head>

  <body>
    <h1> A Study of the Top Universities in the United States </h1>
    <p>Body text.</p>
    <svg class="outline" id="tuition" width="200" height="200"></svg>
    <svg class="outline" id="debt" width="200" height="200"></svg>
    <svg class="outline" id="earnings" width="200" height="200"></svg>
    <svg class="outline" id="admission" width="200" height="200"></svg>

    <div class="scatter-container">
      <div>
        <div class="yButtonContainer">
          <span class="arrow arrow-left" id="yArrowLeft"></span>
          <button class="button" id="yButton">Cost</button>
          <span class="arrow" id="yArrowRight"></span>
        </div>

        <svg id="scatter" width="800" height="800"></svg>
      </div>

      <div>
        <span class="arrow arrow-left" id="xArrowLeft"></span>
        <button id="xButton" class="button">Admission Rate</button>
        <span class="arrow" id="xArrowRight"></span>
      </div>
    </div>

    <script>
      // function to update the chart based on the selected variables
    //   async function updateChart() {
    //     let data = await d3.csv("rest.csv", d3.autoType);
    //     let svg = d3.select("#scatter");
    //     console.log("running update chart");
    //     console.log(data);
    //     var xVariable = varLabels[xLabelIndex];
    //     var yVariable = varLabels[yLabelIndex];

    //     console.log("X", xVariable);
    //     console.log("Y", yVariable);

    //     const newXExtent = d3.extent(data, (d) => d[xVariable]);
    //     const newYExtent = d3.extent(data, (d) => d[yVariable]);

    //     const newXScale = d3.scaleLinear().domain(newXExtent).range([0, 720]);
    //     const newYScale = d3.scaleLinear().domain(newYExtent).range([750, 0]);

    //     var xAxis = d3.axisBottom().scale(newXScale);
    //     var yAxis = d3.axisLeft().scale(newYScale);

    //     svg.select("#scatterXAxis").transition().duration(500).call(xAxis);
    //     svg.select("#scatterYAxis").transition().duration(500).call(yAxis);

    //     d3.selectAll("circle")
    //       .transition()
    //       .duration(500)
    //       .attr("cx", (d) => newXScale(d[xVariable]))
    //       .attr("cy", (d) => newYScale(d[yVariable]));
    //   }

      // Define the initial button label and index of the label array
    var buttonLabels = ["Cost", "Debt", "Median Earnings", "Admission Rate"];

    var varLabels = [
        "COSTT4_A",
        "GRAD_DEBT_MDN",
        "MD_EARN_WNE_P10",
        "ADM_RATE",
    ];

    const createGraph = async function () {
        let ivies = await d3.csv("ivies.csv", d3.autoType);
        let rest = await d3.csv("rest.csv", d3.autoType);

        console.log(ivies);
        console.log(rest);

        function makeScatter(xIndex, yIndex){
            const scatter = d3.select("#scatter");
            const swidth = scatter.attr("width");
            const sheight = scatter.attr("height");
            const sMargin = { top: 10, right: 20, bottom: 40, left: 60 };
            const sChartWidth = swidth - sMargin.right - sMargin.left;
            const sChartHeight = sheight - sMargin.top - sMargin.bottom;

            var xVariable = varLabels[xIndex];
            var yVariable = varLabels[yIndex];

            //console.log(sChartHeight, sChartWidth);

            let annotations = scatter.append("g").attr("id", "annotations");
            let scatterArea = scatter.append("g")
                                .attr("id", "points")
                                .attr("transform","translate(" + sMargin.left + "," + sMargin.top + ")");       

            // whatever variables the user chooses, need to adjust this code to deal with the variables that the user can choose
            // maybe create it's own function that reacts to what the user inputs
            const xExtent = d3.extent(rest, (d) => d[xVariable]);
            const yExtent = d3.extent(rest, (d) => d[yVariable]);

            const xScale = d3.scaleLinear().domain(xExtent).range([0, sChartWidth]);
            // switching min and max to account for SVG coordinates
            const yScale = d3
                    .scaleLinear()
                    .domain(yExtent)
                    .range([sChartHeight, 0]);
            
            // part C
            // left axis
            let sLeftAxis = d3.axisLeft(yScale);
            scatter.append("g")
                    .attr("id", "scatterYAxis")
                    .attr("transform", `translate(${sMargin.left - 10},${sMargin.top})`)

            // left gridlines
            let sLeftGridlines = d3
                        .axisLeft(yScale)
                        .tickSize(-sChartWidth - 10)
                        .tickFormat("");
            scatter.append("g")
                    .attr("class", "y gridlines")
                    .attr("id", "scatterYGrid")
                    .attr("transform", `translate(${sMargin.left - 10},${sMargin.top})`)

            // bottom axis
            let sBottomAxis = d3.axisBottom(xScale);
            scatter.append("g")
                    .attr("class", "x axis")
                    .attr("id", "scatterXAxis")
                    .attr(
                        "transform",
                        `translate(${sMargin.left},${sChartHeight + sMargin.top + 10})`
                    )

            // bottom gridlines
            let sBottomGridlines = d3
                                .axisBottom(xScale)
                                .tickSize(-sChartHeight - 10)
                                .tickFormat("");
            scatter.append("g")
                .attr("class", "x gridlines")
                .attr("id", "scatterXGrid")
                .attr(
                    "transform",
                    `translate(${sMargin.left},${sChartHeight + sMargin.top + 10})`
                )

            scatter.select("#scatterXAxis").transition().duration(500).call(sBottomAxis);
            scatter.select("#scatterXGrid").transition().duration(500).call(sBottomGridlines);
            scatter.select("#scatterYAxis").transition().duration(500).call(sLeftAxis);
            scatter.select("#scatterYGrid").transition().duration(500).call(sLeftGridlines);

            scatterArea
                    .selectAll("circle.point")
                    .data(rest)
                    .join( (enter) => 
                        enter.append("circle")
                        .attr("class", "point")
                        .attr("cx", (d) => xScale(d[xVariable]))
                        .attr("cy", (d) => yScale(d[yVariable]))
                        .attr("r", 5)
                        .attr("fill", "blue"))
                    .transition()
                    .duration(500);
        }

        // eventually make the code below into a function we can just repeat for the 4 histograms

        function makeHistogram(svg, attribute) {
          const histo = d3.select(svg);
          const width = histo.attr("width");
          const height = histo.attr("height");
          const histoMargin = { top: 10, right: 20, bottom: 20, left: 30 };
          const histoWidth = width - histoMargin.right - histoMargin.left;
          const histoHeight = height - histoMargin.top - histoMargin.bottom;

          let annotations = histo.append("g").attr("id", "annotations");
          let histoArea = histo
            .append("g")
            .attr("id", "bars")
            .attr(
              "transform",
              "translate(" + histoMargin.left + "," + histoMargin.top + ")"
            );

          // histograms
          let values = rest.map((d) => d[attribute]);
          let minMax = d3.extent(values);

          let xScale = d3.scaleLinear().domain(minMax).range([0, histoWidth]);
          let bottomAxis = d3.axisBottom(xScale).tickFormat("");

          let numBins = 10;
          let histoGen = d3.histogram().domain(minMax).thresholds(numBins);
          //console.log(histoGen);
          let bins = histoGen(values);
          //console.log(bins);
          // do we need to use this?
          // bins.unshift({ x0: 0,
          //            x1: bins[0].x0,
          //            length: bins[0].length });

          let yScale = d3
            .scaleLinear()
            .domain(d3.extent(bins, (d) => d.length))
            .range([histoHeight, 0]);

          let leftAxis = d3.axisLeft(yScale);
          let leftGridlines = d3
            .axisLeft(yScale)
            .tickSize(-histoWidth - 10)
            .tickFormat("");

          annotations
            .append("g")
            .attr("class", "y axis")
            .attr(
              "transform",
              "translate(" +
                (histoMargin.left - 10) +
                "," +
                histoMargin.top +
                ")"
            )
            .call(leftAxis);
          annotations
            .append("g")
            .attr("class", "y gridlines")
            .attr(
              "transform",
              "translate(" +
                (histoMargin.left - 10) +
                "," +
                histoMargin.top +
                ")"
            )
            .call(leftGridlines);
          annotations
            .append("g")
            .attr("class", "x axis")
            .attr(
              "transform",
              "translate(" +
                (histoMargin.left - 10) +
                "," +
                (histoHeight + histoMargin.top) +
                ")"
            )
            .call(bottomAxis);

          // let area = d3.area().x(d => xScale(d.x1))
          //                     .y0(yScale(0))
          //                     .y1(d => yScale(d.length))
          //                     .curve(d3.curveNatural);

          // histoArea.append("path").datum(bins)
          //     .attr("class", "area")
          //     .attr("d", area);

          histoArea
            .selectAll("rect")
            .data(bins)
            .join((enter) =>
              enter
                .append("rect")
                .attr("x", (d) => xScale(d.x1))
                .attr("y", (d) => yScale(d.length))
                .attr("width", function (d) {
                  return xScale(d.x1) - xScale(d.x0) - 1;
                })
                .attr("height", function (d) {
                  return histoHeight - yScale(d.length);
                })
                .style("fill", "#69b3a2")
                .style("stroke", "black")
            );
        }

        makeHistogram("#tuition", "COSTT4_A");
        makeHistogram("#debt", "GRAD_DEBT_MDN");
        makeHistogram("#earnings", "MD_EARN_WNE_P10");
        makeHistogram("#admission", "ADM_RATE");


        // update the axis for the scatter plot 
        let xLabel = document.getElementById("xButton");
        let yLabel = document.getElementById("yButton");
        let xArrowLeft = document.getElementById("xArrowLeft");
        let xArrowRight = document.getElementById("xArrowRight");

        let yArrowLeft = document.getElementById("yArrowLeft");
        let yArrowRight = document.getElementById("yArrowRight");

        var xLabelIndex = 3;
        var yLabelIndex = 0;

        // Add click event listeners to the arrows
        xArrowLeft.addEventListener("click", function () {
            console.log("xArrowLeft");
            xLabelIndex = (xLabelIndex - 1) % 4;
            if (xLabelIndex < 0) {
            xLabelIndex = 3;
            }
            xLabel.textContent = buttonLabels[xLabelIndex];
            makeScatter(xLabelIndex, yLabelIndex);
        });
        xArrowRight.addEventListener("click", function () {
            if (xLabelIndex < 3) {
            xLabelIndex = (xLabelIndex + 1) % 4;
            } else {
            xLabelIndex = 0;
            }
            xLabel.textContent = buttonLabels[xLabelIndex];
            makeScatter(xLabelIndex, yLabelIndex);
        });

        yArrowLeft.addEventListener("click", function () {
            yLabelIndex = (yLabelIndex - 1) % 4;
            if (yLabelIndex < 0) {
            yLabelIndex = 3;
            }
            yLabel.textContent = buttonLabels[yLabelIndex];
            makeScatter(xLabelIndex, yLabelIndex);
        });
        yArrowRight.addEventListener("click", function () {
            if (yLabelIndex < 3) {
            yLabelIndex = (yLabelIndex + 1) % 4;
            } else {
            yLabelIndex = 0;
            }
            yLabel.textContent = buttonLabels[yLabelIndex];
            makeScatter(xLabelIndex, yLabelIndex);
        });

    };

    createGraph();
    </script>
</body>
</html>
