<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Project 3</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Georgia", sans-serif;
      }
      .histo {
        background-color: #bbb;
        margin: 10px;
      }
      .gridlines line {
        stroke: #bbb;
      }
      .gridlines .domain {
        stroke: none;
      }
      .button {
        height: 30px;
        width: 200px;
      }
      button {
        font-size: 16px;
        padding: 8px;
        width: 200px;
        border: none;
        background-color: #ddd;
        cursor: pointer;
      }
      button:hover {
        background-color: #ccc;
      }

      .reset {
        width: 200px;
        margin-top: 10px;
        margin-bottom: 20px;
        text-align: center;
        vertical-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .arrow:hover {
        opacity: 0.4;
      }
      .arrow {
        display: inline-block;
        width: 16px;
        height: 16px;
        background-image: url("https://cdn-icons-png.flaticon.com/512/271/271228.png");
        background-size: contain;
        background-repeat: no-repeat;
        cursor: pointer;
      }
      .arrow-left {
        transform: rotate(180deg);
      }

      .scatter-container {
        display: flex;
      }

      .col-2 {
        display: flex;
      }
      .col-3 {
        display: flex;
        align-items: flex-end;
      }
      .histo-section {
        display: flex;
        flex-direction: row;
      }
      .histos {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
      }
      .histo-text {
        width: 50%;
      }
      /* #scatter.div {
        background-color: red;
        height: 100px;
        width: 100px;
      } */
      #inspector {
        border-radius: 10px;
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        height: 370px;
        width: 400px;
        background-color: #fff2ce;
        display: flex;
        justify-content: flex-start;
        flex-direction: column;
        color: #002947;
      }
      #inspector-header {
        text-align: center;
        border-bottom: 1px solid grey;
        padding: 5px;
      }
      #details {
        margin-left: 20px;
        margin-right: 20px;
        color: #002947;
      }

      #inspector2 {
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        margin-top: 30px;
        height: 370px;
        width: 400px;
        background-color: #6bbcd1;
        display: flex;
        justify-content: flex-start;
        flex-direction: column;
        display: none;
      }

      #inspector2-outline {
        margin-top: 30px;
        height: 370px;
        width: 400px;
        border: 2px dashed grey;
        display: none;
        text-align: center;
      }

      #inspector-header2 {
        text-align: center;
        border-bottom: 1px solid grey;
      }
      #details2 {
        margin-left: 20px;
        margin-right: 20px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
      }

      th,
      td {
        text-align: left;
        padding: 8px;
      }

      th {
        background-color: #f2f2f2;
      }

      tr.alt {
        background-color: #fce39f;
      }

      tr.alt2 {
        background-color: #3eb4d1;
      }

      #detail-table {
        visibility: hidden;
      }

      header {
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background-image: url("ivy_resized.png");
        margin-bottom: 20px;
      }
      .header-text {
        color: black;
        background-color: white;
        text-align: center;
      }
      h3 {
        font-weight: normal;
      }
      h1 {
        font-weight: bold;
      }
      .green {
        color: green;
      }
      .red {
        color: red;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="header-text">
        <h1>A Study of the Top Universities in the United States</h1>
        <h3>
          Are the prestigious Ivy League schools worth your while? Let's find
          out.
        </h3>
      </div>
    </header>
    <div class="histo-section">
      <div class="histo-text">
        <p>Describe histograms here.</p>
      </div>
      <div class="histos">
        <svg class="histo" id="tuition" width="300" height="300"></svg>
        <svg class="histo" id="debt" width="300" height="300"></svg>
        <svg class="histo" id="earnings" width="300" height="300"></svg>
        <svg class="histo" id="admission" width="300" height="300"></svg>
      </div>
    </div>

    <div class="scatter-container">
      <div class="col-1 col">
        <div class="yButtonContainer">
          <span class="arrow arrow-left" id="yArrowLeft"></span>
          <button class="button" id="yButton">Cost</button>
          <span class="arrow" id="yArrowRight"></span>
        </div>
      </div>

      <div class="col col-2">
        <svg id="scatter" width="800" height="800"></svg>
        <div>
          <div id="inspector">
            <div id="inspector-header">
              <h2 id="name">Hover over a college to view details...</h2>
            </div>
            <div id="details">
              <table id="detail-table">
                <tbody>
                  <tr>
                    <td>Cost</td>
                    <td id="costText">&nbsp;</td>
                  </tr>
                  <tr class="alt">
                    <td>Admission Rate</td>
                    <td id="adText">&nbsp;</td>
                  </tr>
                  <tr>
                    <td>Debt</td>
                    <td id="debtText">&nbsp;</td>
                  </tr>
                  <tr class="alt">
                    <td>Median Income</td>
                    <td id="inText">&nbsp;</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <h2 style="margin-left: 20px" id="instruct">
            Click a college to begin comparison...
          </h2>

          <div id="inspector2">
            <div id="inspector-header">
              <h2 id="name2">&nbsp;</h2>
            </div>
            <div id="details2">
              <table id="detail-table2">
                <tbody>
                  <tr>
                    <td>Cost</td>
                    <td id="costText2">&nbsp;</td>
                  </tr>
                  <tr class="alt2">
                    <td>Admission Rate</td>
                    <td id="adText2">&nbsp;</td>
                  </tr>
                  <tr>
                    <td>Debt</td>
                    <td id="debtText2">&nbsp;</td>
                  </tr>
                  <tr class="alt2">
                    <td>Median Income</td>
                    <td id="inText2">&nbsp;</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="inspector2-outline">
            <h2>Hover the click then click on another college to compare...</h2>
          </div>
        </div>
      </div>

      <div class="col col-3">
        <div class="xButtonContainer">
          <span class="arrow arrow-left" id="xArrowLeft"></span>
          <button id="xButton" class="button">Admission Rate</button>
          <span class="arrow" id="xArrowRight"></span>
        </div>
      </div>
    </div>

    <script>
      // Define the initial button label and index of the label array
      var buttonLabels = ["Cost", "Debt", "Median Earnings", "Admission Rate"];

      var varLabels = [
        "COSTT4_A",
        "GRAD_DEBT_MDN",
        "MD_EARN_WNE_P10",
        "ADM_RATE",
      ];

      var numSelected = 0;

      var firstLoad = true;

      function compareValues(type) {
        console.log("looking for ", type);
        var val1 = document.getElementById(type).innerText;
        var val2 = document.getElementById(`${type}2`).innerText;

        console.log("values: ", val1, val2);

        var percentChangeVal1 = val2 - val1;
        var percentChangeVal2 = val1 - val2;

        if (type == "adTest") {
          percentChangeVal1 = val2 - val1;
          percentChangeVal2 = val1 - val2;
        }

        console.log(percentChangeVal1);

        return [percentChangeVal1, percentChangeVal2];
      }

      function getHTML(value) {
        if (value < 0) {
          return `<span class="red"> (${d3.format(",f")(value)})</span>`;
        } else {
          return `<span class="green"> (+${d3.format(",f")(value)})</span>`;
        }
      }

      function addCompareValues(inspector, cost, ad, debt, inc) {
        document.getElementById(`costText${inspector}`).innerHTML +=
          getHTML(cost);
        document.getElementById(`adText${inspector}`).innerHTML += getHTML(ad);
        document.getElementById(`debtText${inspector}`).innerHTML +=
          getHTML(debt);
        document.getElementById(`inText${inspector}`).innerHTML += getHTML(inc);
      }

      const createGraph = async function () {
        let ivies = await d3.csv("ivies.csv", d3.autoType);
        let rest = await d3.csv("rest.csv", d3.autoType);
        let total = await d3.csv("top_data.csv", d3.autoType);
        console.log(total);

        function makeScatter(xIndex, yIndex) {
          const scatter = d3.select("#scatter");
          const swidth = scatter.attr("width");
          const sheight = scatter.attr("height");
          const sMargin = { top: 10, right: 20, bottom: 40, left: 60 };
          const sChartWidth = swidth - sMargin.right - sMargin.left;
          const sChartHeight = sheight - sMargin.top - sMargin.bottom;

          var xVariable = varLabels[xIndex];
          var yVariable = varLabels[yIndex];

          //console.log(sChartHeight, sChartWidth);

          let annotations = scatter.append("g").attr("id", "annotations");
          let scatterArea = scatter
            .append("g")
            .attr("id", "points")
            .attr(
              "transform",
              "translate(" + sMargin.left + "," + sMargin.top + ")"
            );

          // whatever variables the user chooses, need to adjust this code to deal with the variables that the user can choose
          // maybe create it's own function that reacts to what the user inputs
          const xExtent = d3.extent(total, (d) => d[xVariable]);
          const yExtent = d3.extent(total, (d) => d[yVariable]);
          const rExtent = d3.extent(total, (d) => d["UGDS"]);

          const xScale = d3
            .scaleLinear()
            .domain(xExtent)
            .range([0, sChartWidth]);
          // switching min and max to account for SVG coordinates
          const yScale = d3
            .scaleLinear()
            .domain(yExtent)
            .range([sChartHeight, 0]);

          const rScale = d3.scaleLinear().domain(rExtent).range([4, 10]);

          // part C
          // left axis
          let sLeftAxis = d3.axisLeft(yScale);
          scatter
            .append("g")
            .attr("id", "scatterYAxis")
            .attr(
              "transform",
              `translate(${sMargin.left - 10},${sMargin.top})`
            );

          // left gridlines
          let sLeftGridlines = d3
            .axisLeft(yScale)
            .tickSize(-sChartWidth - 10)
            .tickFormat("");
          scatter
            .append("g")
            .attr("class", "y gridlines")
            .attr("id", "scatterYGrid")
            .attr(
              "transform",
              `translate(${sMargin.left - 10},${sMargin.top})`
            );

          // bottom axis
          let sBottomAxis = d3.axisBottom(xScale);
          scatter
            .append("g")
            .attr("class", "x axis")
            .attr("id", "scatterXAxis")
            .attr(
              "transform",
              `translate(${sMargin.left},${sChartHeight + sMargin.top + 10})`
            );

          // bottom gridlines
          let sBottomGridlines = d3
            .axisBottom(xScale)
            .tickSize(-sChartHeight - 10)
            .tickFormat("");
          scatter
            .append("g")
            .attr("class", "x gridlines")
            .attr("id", "scatterXGrid")
            .attr(
              "transform",
              `translate(${sMargin.left},${sChartHeight + sMargin.top + 10})`
            );

          scatter
            .select("#scatterXAxis")
            .transition()
            .duration(500)
            .call(sBottomAxis);
          scatter
            .select("#scatterXGrid")
            .transition()
            .duration(500)
            .call(sBottomGridlines);
          scatter
            .select("#scatterYAxis")
            .transition()
            .duration(500)
            .call(sLeftAxis);
          scatter
            .select("#scatterYGrid")
            .transition()
            .duration(500)
            .call(sLeftGridlines);

          // just adjust points
          if (firstLoad == false) {
            console.log("second load");
            scatter
              .selectAll(".point")
              .transition()
              .duration(500)
              .attr("cx", (d) => xScale(d[xVariable]))
              .attr("cy", (d) => yScale(d[yVariable]));
          }
          // create initial points on first load
          else {
            console.log("first load");
            scatterArea
              .selectAll("circle")
              .data(total)
              .join((enter) =>
                enter
                  .append("circle")
                  .attr("class", "point")
                  .attr("name", (d) => d["INSTNM"])
                  .attr("cost", (d) => d["COSTT4_A"])
                  .attr("ad", (d) => d["ADM_RATE"])
                  .attr("debt", (d) => d["GRAD_DEBT_MDN"])
                  .attr("in", (d) => d["MD_EARN_WNE_P10"])
                  .attr("y", (d) => yScale(d[yVariable]))
                  .attr("cx", (d) => xScale(d[xVariable]))
                  .attr("cy", (d) => yScale(d[yVariable]))
                  .attr("r", (d) => rScale(d["UGDS"]))
              )
              .attr("fill", (d) => {
                if (d["ivy"] === "True") {
                  return "#FD9415";
                } else {
                  return "#6bbcd1";
                }
              })
              .on("mouseover", function (d) {
                console.log("moused over");
                // Get the name of the circle
                var c = d3.select(this);
                var name = c.attr("name");
                var cost = c.attr("cost");
                var ad = c.attr("ad");
                var debt = c.attr("debt");
                var inc = c.attr("in");
                var r = c.attr("r");

                console.log("vars: ", name, cost, ad, debt, inc);

                // only update first inspector if no circle is selected
                if (numSelected == 0) {
                  console.log(c, name, cost);

                  document.getElementById("name").innerText = name;
                  document.getElementById("costText").innerText = cost;
                  document.getElementById("adText").innerText = ad;
                  document.getElementById("debtText").innerText = debt;
                  document.getElementById("inText").innerText = inc;

                  document.getElementById("detail-table").style.visibility =
                    "visible";
                }

                // update second inspector
                const name1 = document.getElementById("name").innerText;
                if (numSelected == 1 && name1 != name) {
                  document.getElementById("inspector2-outline").style.display =
                    "none";
                  document.getElementById("name2").innerText = name;
                  document.getElementById("costText2").innerText = cost;
                  document.getElementById("adText2").innerText = ad;
                  document.getElementById("debtText2").innerText = debt;
                  document.getElementById("inText2").innerText = inc;

                  // show
                  document.getElementById("detail-table2").style.visibility =
                    "visible";
                  document.getElementById("inspector2").style.display = "flex";
                }
                c.attr("r", r * 1.7);
                c.style("stroke", "black");
              })
              .on("mouseout", function (d) {
                var c = d3.select(this);
                var r = c.attr("r");
                if (c.style("stroke") === "black" && c.attr("r") != "12") {
                  c.attr("r", r / 1.7);
                  c.style("stroke", "");
                } else {
                  c.attr("r", r / 1.7);
                }
              })
              .on("click", function (d) {
                numSelected++;
                var c = d3.select(this);
                // set circle to selected
                if (numSelected == 1) {
                  document.getElementById("instruct").style.display = "none";
                  document.getElementById("inspector2-outline").style.display =
                    "block";
                  c.style("stroke", "black");
                  c.attr("r", 12).transitiom().duration(500);
                }
                if (numSelected == 2) {
                  var costVals = compareValues("costText");
                  var incVals = compareValues("inText");
                  var adVals = compareValues("adText");
                  var debtVals = compareValues("debtText");
                  c.style("stroke", "black");
                  c.attr("r", 12).transitiom().duration(500);

                  addCompareValues(
                    "2",
                    costVals[0],
                    adVals[0],
                    incVals[0],
                    debtVals[0]
                  );

                  addCompareValues(
                    "",
                    costVals[1],
                    adVals[1],
                    incVals[1],
                    debtVals[1]
                  );
                }
              });
            firstLoad = false;
          }
        }

        function makeHistogram(svg, attribute, xlabel) {
          const histo = d3.select(svg);
          const width = histo.attr("width");
          const height = histo.attr("height");
          const histoMargin = { top: 10, right: 20, bottom: 60, left: 30 };
          const histoWidth = width - histoMargin.right - histoMargin.left;
          const histoHeight = height - histoMargin.top - histoMargin.bottom;

          let annotations = histo.append("g").attr("id", "annotations");
          let histoArea = histo
            .append("g")
            .attr("id", "bars")
            .attr(
              "transform",
              "translate(" + histoMargin.left + "," + histoMargin.top + ")"
            );

          // histograms
          let rest_values = rest.map((d) => d[attribute]);
          let rest_minMax = d3.extent(rest_values);
          let ivy_values = ivies.map((d) => d[attribute]);

          let xScale = d3
            .scaleLinear()
            .domain(rest_minMax)
            .range([0, histoWidth]);
          let bottomAxis = d3.axisBottom(xScale);

          let numBins = 10;
          let histoGen = d3.histogram().domain(rest_minMax).thresholds(numBins);

          // the smaller rectangles are from the fact that it's not even distribution in the bins right?
          let rest_bins = histoGen(rest_values);
          console.log("rest histo", rest_bins);
          let ivy_bins = histoGen(ivy_values);
          console.log("ivy histo", ivy_bins);

          // y axis
          let yScale = d3
            .scaleLinear()
            .domain(d3.extent(rest_bins, (d) => d.length))
            .range([histoHeight, 0]);

          let leftAxis = d3.axisLeft(yScale);
          let leftGridlines = d3
            .axisLeft(yScale)
            .tickSize(-histoWidth - 10)
            .tickFormat("");

          annotations
            .append("g")
            .attr("class", "y axis")
            .attr(
              "transform",
              "translate(" +
                (histoMargin.left - 10) +
                "," +
                histoMargin.top +
                ")"
            )
            .call(leftAxis);

          annotations
            .append("g")
            .attr("class", "y gridlines")
            .attr(
              "transform",
              "translate(" +
                (histoMargin.left - 10) +
                "," +
                histoMargin.top +
                ")"
            )
            .call(leftGridlines);

          annotations
            .append("g")
            .attr("class", "x axis")
            .attr(
              "transform",
              "translate(" +
                histoMargin.left +
                "," +
                (histoHeight + histoMargin.top) +
                ")"
            )
            .call(bottomAxis)
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("transform", "translate(-10, 2) rotate(-65)");

          let rest_rectangles = histoArea
            .selectAll("rect.rest")
            .data(rest_bins)
            .join("rect")
            .attr("class", "rest")
            .attr("x", (d) => xScale(d.x0))
            .attr("y", (d) => yScale(d.length))
            .attr("width", function (d) {
              return xScale(d.x1) - xScale(d.x0);
            })
            .attr("height", function (d) {
              return histoHeight - yScale(d.length);
            })
            .style("fill", "blue")
            .style("stroke", "black")
            .style("stroke-width", 1)
            .style("opacity", 1.0)
            .on("mouseover", mouseOverRect)
            .on("mouseout", mouseOutRect);

          let ivy_rectangles = histoArea
            .selectAll("rect.ivy")
            .data(ivy_bins)
            .join("rect")
            .attr("class", "ivy")
            .attr("x", (d) => xScale(d.x0))
            .attr("y", (d) => yScale(d.length))
            .attr("width", function (d) {
              return xScale(d.x1) - xScale(d.x0);
            })
            .attr("height", function (d) {
              return histoHeight - yScale(d.length);
            })
            .style("fill", "gold")
            .style("stroke", "black")
            .style("stroke-width", 1)
            .style("opacity", 1.0)
            .on("mouseover", mouseOverRect)
            .on("mouseout", mouseOutRect);

          annotations
            .append("text")
            .attr("class", "x label")
            .attr("text-anchor", "middle")
            .attr("x", histoWidth / 2 + histoMargin.left)
            .attr("y", histoHeight + histoMargin.bottom)
            .text(xlabel);
        }

        // QUESTION - is there a way to recover the data points that fall into each point? Like if we want to show list of colleges
        function mouseOverRect(event, d) {
          let obj = d3.select(this);
          let number = d.length;
          obj.style("stroke-width", 3);

          // how would I show the number of schools and which ones?
        }
        function mouseOutRect(event, d) {
          let obj = d3.select(this);
          obj.style("stroke-width", 1);
        }

        makeHistogram("#tuition", "COSTT4_A", "Average Annual Cost");
        makeHistogram("#debt", "GRAD_DEBT_MDN", "Median Debt");
        makeHistogram("#earnings", "MD_EARN_WNE_P10", "Median Earnings");
        makeHistogram("#admission", "ADM_RATE", "Admission Rate");
        makeScatter(3, 0);

        // update the axis for the scatter plot
        let xLabel = document.getElementById("xButton");
        let yLabel = document.getElementById("yButton");
        let xArrowLeft = document.getElementById("xArrowLeft");
        let xArrowRight = document.getElementById("xArrowRight");

        let yArrowLeft = document.getElementById("yArrowLeft");
        let yArrowRight = document.getElementById("yArrowRight");

        var xLabelIndex = 3;
        var yLabelIndex = 0;

        // Add click event listeners to the arrows
        xArrowLeft.addEventListener("click", function () {
          console.log("xArrowLeft");
          xLabelIndex = (xLabelIndex - 1) % 4;
          if (xLabelIndex < 0) {
            xLabelIndex = 3;
          }
          xLabel.textContent = buttonLabels[xLabelIndex];
          makeScatter(xLabelIndex, yLabelIndex);
        });
        xArrowRight.addEventListener("click", function () {
          if (xLabelIndex < 3) {
            xLabelIndex = (xLabelIndex + 1) % 4;
          } else {
            xLabelIndex = 0;
          }
          xLabel.textContent = buttonLabels[xLabelIndex];
          makeScatter(xLabelIndex, yLabelIndex);
        });

        yArrowLeft.addEventListener("click", function () {
          yLabelIndex = (yLabelIndex - 1) % 4;
          if (yLabelIndex < 0) {
            yLabelIndex = 3;
          }
          yLabel.textContent = buttonLabels[yLabelIndex];
          makeScatter(xLabelIndex, yLabelIndex);
        });
        yArrowRight.addEventListener("click", function () {
          if (yLabelIndex < 3) {
            yLabelIndex = (yLabelIndex + 1) % 4;
          } else {
            yLabelIndex = 0;
          }
          yLabel.textContent = buttonLabels[yLabelIndex];
          makeScatter(xLabelIndex, yLabelIndex);
        });
      };

      createGraph();
    </script>
  </body>
</html>
